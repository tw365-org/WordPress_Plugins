/**
 * Plugin Name: My-Tiny-Admin-AI-Companion
 * Description: ä¼æ¥­ç´š WordPress å¾Œå° AI æ™ºèƒ½åŠ©æ‰‹ï¼Œæ•´åˆ ChatGPT, Gemini, Grok, Groqã€‚å·²æ›´æ–° Groq æ¨¡å‹ç‚ºæœ€æ–°çš„ Llama 3.3ã€‚
 * Version: 1.3.2 (Groq Model Fixed)
 * Author: WP TW Architect
 * Text Domain: my-tiny-admin-ai
 * Requires at least: 6.0
 * Requires PHP: 7.4
 * License: GPLv2 or later
 */

if ( ! defined( 'ABSPATH' ) ) {
    exit; // è³‡å®‰é˜²è­·ï¼šé˜²æ­¢ç›´æ¥å­˜å–æª”æ¡ˆ
}

/**
 * Class My_Tiny_Admin_AI_Companion
 * æ ¸å¿ƒæ§åˆ¶å™¨ï¼šè² è²¬è¨­å®šã€UI æ¸²æŸ“èˆ‡ API è«‹æ±‚è½‰ç™¼ã€‚
 */
class My_Tiny_Admin_AI_Companion {

    const OPTION_KEY = 'my_tiny_admin_ai_config';
    const NONCE_ACTION = 'my_tiny_admin_ai_chat_nonce';

    public function __construct() {
        if ( is_admin() ) {
            add_action( 'admin_menu', [ $this, 'register_settings_page' ] );
            add_action( 'admin_init', [ $this, 'register_settings' ] );
            add_action( 'admin_footer', [ $this, 'render_chat_interface' ] );
        }

        // AJAX Handlers
        add_action( 'wp_ajax_my_tiny_admin_ai_chat', [ $this, 'handle_chat_request' ] );
        add_action( 'wp_ajax_my_tiny_admin_ai_test_connection', [ $this, 'handle_test_connection' ] );
    }

    // =========================================================================
    // 1. è¨­å®šé é¢ (Settings)
    // =========================================================================

    public function register_settings_page() {
        add_options_page(
            'My Tiny Admin AI è¨­å®š',
            'My Tiny AI',
            'manage_options',
            'my-tiny-admin-ai-settings',
            [ $this, 'render_settings_form' ]
        );
    }

    public function register_settings() {
        register_setting( 'my_tiny_admin_ai_settings_group', self::OPTION_KEY, [
            'sanitize_callback' => [ $this, 'sanitize_config' ]
        ] );
    }

    public function sanitize_config( $input ) {
        $clean = [];
        if ( isset( $input['openai_key'] ) ) $clean['openai_key'] = sanitize_text_field( $input['openai_key'] );
        if ( isset( $input['gemini_key'] ) ) $clean['gemini_key'] = sanitize_text_field( $input['gemini_key'] );
        if ( isset( $input['grok_key'] ) )   $clean['grok_key']   = sanitize_text_field( $input['grok_key'] );
        if ( isset( $input['groq_key'] ) )   $clean['groq_key']   = sanitize_text_field( $input['groq_key'] );
        return $clean;
    }

    public function render_settings_form() {
        if ( ! current_user_can( 'manage_options' ) ) return;
        $config = get_option( self::OPTION_KEY, [] );
        ?>
        <div class="wrap">
            <h1>My-Tiny-Admin-AI-Companion è¨­å®š</h1>
            <p>è¨­å®šå„å®¶ AI æ¨¡å‹çš„ API Keyã€‚ç³»çµ±å·²æ›´æ–° Groq æ¨¡å‹ç‚ºæœ€æ–°çš„ Llama 3.3ï¼Œè«‹é‡æ–°æ¸¬è©¦é€£ç·šã€‚</p>
            
            <form method="post" action="options.php">
                <?php settings_fields( 'my_tiny_admin_ai_settings_group' ); ?>
                <table class="form-table">
                    <tr valign="top">
                        <th scope="row">OpenAI API Key</th>
                        <td>
                            <div style="display: flex; gap: 10px; align-items: center;">
                                <input type="password" id="input_openai" name="<?php echo esc_attr( self::OPTION_KEY ); ?>[openai_key]" value="<?php echo esc_attr( $config['openai_key'] ?? '' ); ?>" class="regular-text" />
                                <button type="button" class="button ai-test-btn" data-provider="openai" data-input="input_openai">æ¸¬è©¦é€£ç·š</button>
                                <span class="test-result" id="res_input_openai"></span>
                            </div>
                            <p class="description">æ¨¡å‹ï¼šGPT-4o / GPT-3.5</p>
                        </td>
                    </tr>
                    <tr valign="top">
                        <th scope="row">Google Gemini API Key</th>
                        <td>
                            <div style="display: flex; gap: 10px; align-items: center;">
                                <input type="password" id="input_gemini" name="<?php echo esc_attr( self::OPTION_KEY ); ?>[gemini_key]" value="<?php echo esc_attr( $config['gemini_key'] ?? '' ); ?>" class="regular-text" />
                                <button type="button" class="button ai-test-btn" data-provider="gemini" data-input="input_gemini">æ¸¬è©¦é€£ç·š</button>
                                <span class="test-result" id="res_input_gemini"></span>
                            </div>
                            <p class="description">æ¨¡å‹ï¼šGemini 1.5 Flash (è‡ªå‹•é™ç´šè‡³ Pro)</p>
                        </td>
                    </tr>
                    <tr valign="top">
                        <th scope="row">xAI Grok API Key</th>
                        <td>
                            <div style="display: flex; gap: 10px; align-items: center;">
                                <input type="password" id="input_grok" name="<?php echo esc_attr( self::OPTION_KEY ); ?>[grok_key]" value="<?php echo esc_attr( $config['grok_key'] ?? '' ); ?>" class="regular-text" />
                                <button type="button" class="button ai-test-btn" data-provider="grok" data-input="input_grok">æ¸¬è©¦é€£ç·š</button>
                                <span class="test-result" id="res_input_grok"></span>
                            </div>
                            <p class="description">æ¨¡å‹ï¼šGrok Beta</p>
                        </td>
                    </tr>
                    <tr valign="top">
                        <th scope="row">Groq API Key</th>
                        <td>
                            <div style="display: flex; gap: 10px; align-items: center;">
                                <input type="password" id="input_groq" name="<?php echo esc_attr( self::OPTION_KEY ); ?>[groq_key]" value="<?php echo esc_attr( $config['groq_key'] ?? '' ); ?>" class="regular-text" />
                                <button type="button" class="button ai-test-btn" data-provider="groq" data-input="input_groq">æ¸¬è©¦é€£ç·š</button>
                                <span class="test-result" id="res_input_groq"></span>
                            </div>
                            <p class="description">æ¨¡å‹ï¼šLlama 3.3 70B (æœ€æ–°ç‰ˆ)</p>
                        </td>
                    </tr>
                </table>
                <?php submit_button(); ?>
            </form>
        </div>

        <script>
        document.addEventListener('DOMContentLoaded', function() {
            const btns = document.querySelectorAll('.ai-test-btn');
            btns.forEach(btn => {
                btn.addEventListener('click', async (e) => {
                    const provider = btn.dataset.provider;
                    const inputId = btn.dataset.input;
                    const inputEl = document.getElementById(inputId);
                    const resEl = document.getElementById('res_' + inputId);
                    const apiKey = inputEl.value.trim();

                    if (!apiKey) {
                        resEl.innerHTML = '<span style="color:red;">âŒ è«‹å…ˆè¼¸å…¥ Key</span>';
                        return;
                    }

                    btn.disabled = true;
                    btn.innerText = 'æ¸¬è©¦ä¸­...';
                    resEl.innerHTML = '';

                    try {
                        const formData = new FormData();
                        formData.append('action', 'my_tiny_admin_ai_test_connection');
                        formData.append('nonce', '<?php echo wp_create_nonce( self::NONCE_ACTION ); ?>');
                        formData.append('provider', provider);
                        formData.append('api_key', apiKey); 

                        const response = await fetch(ajaxurl, { method: 'POST', body: formData });
                        const data = await response.json();

                        if (data.success) {
                            resEl.innerHTML = '<span style="color:green; font-weight:bold;">âœ… é€£ç·šæˆåŠŸ</span>';
                        } else {
                            resEl.innerHTML = '<span style="color:red;">âŒ å¤±æ•—: ' + (data.data || 'æœªçŸ¥éŒ¯èª¤') + '</span>';
                        }
                    } catch (err) {
                        resEl.innerHTML = '<span style="color:red;">âŒ ç¶²è·¯éŒ¯èª¤</span>';
                    } finally {
                        btn.disabled = false;
                        btn.innerText = 'æ¸¬è©¦é€£ç·š';
                    }
                });
            });
        });
        </script>
        <?php
    }

    // =========================================================================
    // 2. æ‡¸æµ®è¦–çª— UI
    // =========================================================================

    public function render_chat_interface() {
        if ( ! current_user_can( 'manage_options' ) ) return;
        ?>
        <div id="my-tiny-admin-ai-widget" style="position: fixed; bottom: 20px; right: 20px; z-index: 99999; font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;">
            
            <button id="my-tiny-admin-ai-toggle" title="é–‹å•Ÿ AI åŠ©æ‰‹" style="width: 60px; height: 60px; border-radius: 50%; background: #2271b1; color: #fff; border: none; box-shadow: 0 4px 12px rgba(0,0,0,0.15); cursor: pointer; display: flex; align-items: center; justify-content: center;">
                <span class="dashicons dashicons-superhero" style="font-size: 28px; width: 28px; height: 28px;"></span>
            </button>

            <div id="my-tiny-admin-ai-window" style="display: none; position: absolute; bottom: 80px; right: 0; width: 380px; height: 500px; background: #fff; border: 1px solid #ccd0d4; border-radius: 8px; box-shadow: 0 5px 15px rgba(0,0,0,0.2); flex-direction: column; overflow: hidden;">
                
                <div style="padding: 12px 15px; background: #f0f0f1; border-bottom: 1px solid #ccd0d4; display: flex; justify-content: space-between; align-items: center;">
                    <strong style="font-size:14px;">My Tiny AI</strong>
                    <span id="my-tiny-admin-ai-close" style="cursor:pointer; color:#666; font-size:18px; padding:0 5px;">&times;</span>
                </div>

                <div id="my-tiny-admin-ai-messages" style="flex: 1; padding: 15px; overflow-y: auto; background: #fff; font-size: 14px; line-height: 1.5;">
                    <div class="ai-msg" style="background: #f0f6fc; padding: 10px 12px; border-radius: 8px; margin-bottom: 10px; color: #1d2327; border: 1px solid #e2e4e7;">
                        ğŸ‘‹ ä½ å¥½ï¼æˆ‘æ˜¯ä½ çš„å¾Œå° AI åŠ©æ‰‹ã€‚<br>è‹¥éœ€è¦æŸ¥è©¢æœ€æ–°è³‡è¨Šï¼Œè«‹é¸æ“‡ Gemini ä¸¦å‹¾é¸ã€Œè¯ç¶²ã€ã€‚
                    </div>
                </div>

                <div style="padding: 10px; border-top: 1px solid #ccd0d4; display: flex; gap: 8px; background: #f6f7f7; align-items: center;">
                    
                    <select id="my-tiny-admin-ai-model" style="font-size: 12px; padding: 0 20px 0 5px; height: 36px; border: 1px solid #8c8f94; border-radius: 4px; cursor: pointer; background-color: #fff; flex-shrink: 0;">
                        <option value="openai">OpenAI</option>
                        <option value="gemini">Gemini</option>
                        <option value="grok">Grok</option>
                        <option value="groq">Groq</option>
                    </select>

                    <label style="display: flex; align-items: center; font-size: 12px; color: #50575e; cursor: pointer; flex-shrink: 0;" title="å•Ÿç”¨ç¶²è·¯æœå°‹ (åƒ… Gemini æ”¯æ´)">
                        <input type="checkbox" id="my-tiny-admin-ai-search" style="margin: 0 4px 0 0;"> è¯ç¶²
                    </label>

                    <input type="text" id="my-tiny-admin-ai-input" placeholder="è¼¸å…¥æŒ‡ä»¤..." style="flex: 1; padding: 8px; height: 36px; border: 1px solid #8c8f94; border-radius: 4px; min-width: 0;">
                    
                    <button id="my-tiny-admin-ai-send" style="background: #2271b1; color: #fff; border: none; padding: 0 15px; height: 36px; border-radius: 4px; cursor: pointer; white-space: nowrap; flex-shrink: 0;">é€å‡º</button>
                </div>
            </div>
        </div>

        <script>
        (function() {
            document.addEventListener('DOMContentLoaded', function() {
                const toggle = document.getElementById('my-tiny-admin-ai-toggle');
                const closeBtn = document.getElementById('my-tiny-admin-ai-close');
                const windowEl = document.getElementById('my-tiny-admin-ai-window');
                const sendBtn = document.getElementById('my-tiny-admin-ai-send');
                const input = document.getElementById('my-tiny-admin-ai-input');
                const msgs = document.getElementById('my-tiny-admin-ai-messages');
                const modelSelect = document.getElementById('my-tiny-admin-ai-model');
                const searchCheck = document.getElementById('my-tiny-admin-ai-search');

                function toggleChat() {
                    if(!windowEl) return;
                    const isHidden = windowEl.style.display === 'none';
                    windowEl.style.display = isHidden ? 'flex' : 'none';
                    if (isHidden && input) input.focus();
                }

                if(toggle) toggle.addEventListener('click', toggleChat);
                if(closeBtn) closeBtn.addEventListener('click', () => { windowEl.style.display = 'none'; });

                function addMessage(text, type) {
                    if(!msgs) return;
                    const div = document.createElement('div');
                    div.style.padding = '10px 12px';
                    div.style.borderRadius = '8px';
                    div.style.marginBottom = '10px';
                    div.style.maxWidth = '90%';
                    div.style.wordBreak = 'break-word';
                    
                    if (type === 'user') {
                        div.style.background = '#2271b1';
                        div.style.color = '#fff';
                        div.style.alignSelf = 'flex-end';
                        div.style.marginLeft = 'auto';
                    } else {
                        div.style.background = '#f0f6fc';
                        div.style.color = '#1d2327';
                        div.style.border = '1px solid #e2e4e7';
                    }
                    let formattedText = text.replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>');
                    formattedText = formattedText.replace(/\n/g, '<br>');
                    div.innerHTML = formattedText; 
                    
                    msgs.appendChild(div);
                    msgs.scrollTop = msgs.scrollHeight; 
                }

                async function handleSend() {
                    if(!input || !sendBtn) return;
                    const text = input.value.trim();
                    if (!text) return;

                    addMessage(text, 'user');
                    input.value = '';
                    input.disabled = true;
                    sendBtn.disabled = true;
                    const originalBtnText = sendBtn.innerText;
                    sendBtn.innerText = '...';

                    try {
                        const formData = new FormData();
                        formData.append('action', 'my_tiny_admin_ai_chat');
                        formData.append('nonce', '<?php echo wp_create_nonce( self::NONCE_ACTION ); ?>');
                        formData.append('message', text);
                        formData.append('provider', modelSelect ? modelSelect.value : 'openai');
                        formData.append('enable_search', searchCheck && searchCheck.checked ? '1' : '0');

                        const response = await fetch(ajaxurl, { method: 'POST', body: formData });
                        const data = await response.json();
                        
                        if (data.success) {
                            addMessage(data.data.reply, 'ai');
                        } else {
                            addMessage('éŒ¯èª¤: ' + (data.data || 'ä¼ºæœå™¨ç•°å¸¸'), 'ai');
                        }
                    } catch (e) {
                        addMessage('é€£ç·šå¤±æ•— (Network Error)', 'ai');
                        console.error(e);
                    } finally {
                        input.disabled = false;
                        sendBtn.disabled = false;
                        sendBtn.innerText = originalBtnText;
                        input.focus();
                    }
                }

                if(sendBtn) sendBtn.addEventListener('click', handleSend);
                if(input) {
                    input.addEventListener('keypress', (e) => {
                        if (e.key === 'Enter') handleSend();
                    });
                }
            });
        })();
        </script>
        <?php
    }

    // =========================================================================
    // 3. AJAX Logic
    // =========================================================================

    public function handle_chat_request() {
        check_ajax_referer( self::NONCE_ACTION, 'nonce' );
        if ( ! current_user_can( 'manage_options' ) ) wp_send_json_error( 'æ¬Šé™ä¸è¶³' );

        $message = sanitize_text_field( $_POST['message'] );
        $provider = sanitize_text_field( $_POST['provider'] );
        $enable_search = isset($_POST['enable_search']) && $_POST['enable_search'] === '1';

        $config = get_option( self::OPTION_KEY, [] );
        $reply = '';

        if ( $enable_search && $provider !== 'gemini' ) {
            $error_msg = "âš ï¸ <strong>åŠŸèƒ½é™åˆ¶æç¤º</strong><br>ç›®å‰åƒ… <strong>Google Gemini</strong> æ”¯æ´å…è¨­å®šåŸç”Ÿè¯ç¶²æœå°‹ã€‚<br><br>è«‹åˆ‡æ›æ¨¡å‹è‡³ Gemini ä»¥ç²å–å³æ™‚è³‡è¨Šã€‚";
            wp_send_json_success( [ 'reply' => $error_msg ] );
            return;
        }

        switch ( $provider ) {
            case 'gemini':
                $reply = $this->call_gemini( $message, $config['gemini_key'] ?? '', $enable_search );
                break;
            case 'grok':
                $reply = $this->call_openai_compatible( $message, $config['grok_key'] ?? '', 'https://api.x.ai/v1/chat/completions', 'grok-beta', 'xAI Grok' );
                break;
            case 'groq':
                // [FIXED] Updated to Llama 3.3
                $reply = $this->call_openai_compatible( $message, $config['groq_key'] ?? '', 'https://api.groq.com/openai/v1/chat/completions', 'llama-3.3-70b-versatile', 'Groq' );
                break;
            case 'openai':
            default:
                $reply = $this->call_openai_compatible( $message, $config['openai_key'] ?? '', 'https://api.openai.com/v1/chat/completions', 'gpt-4o', 'OpenAI' );
                break;
        }

        if ( is_wp_error( $reply ) ) wp_send_json_error( $reply->get_error_message() );
        wp_send_json_success( [ 'reply' => $reply ] );
    }

    public function handle_test_connection() {
        check_ajax_referer( self::NONCE_ACTION, 'nonce' );
        if ( ! current_user_can( 'manage_options' ) ) wp_send_json_error( 'æ¬Šé™ä¸è¶³' );

        $provider = sanitize_text_field( $_POST['provider'] );
        $api_key  = sanitize_text_field( $_POST['api_key'] );

        if ( empty( $api_key ) ) {
            $labels = ['openai'=>'OpenAI', 'gemini'=>'Google Gemini', 'grok'=>'xAI Grok', 'groq'=>'Groq'];
            $label = $labels[$provider] ?? 'API';
            wp_send_json_error( "æœªè¨­å®š $label API Key" );
        }

        $test_message = "Hello (Ping Test)";
        $reply = '';

        switch ( $provider ) {
            case 'gemini':
                $reply = $this->call_gemini( $test_message, $api_key, false );
                break;
            case 'grok':
                $reply = $this->call_openai_compatible( $test_message, $api_key, 'https://api.x.ai/v1/chat/completions', 'grok-beta', 'xAI Grok' );
                break;
            case 'groq':
                // [FIXED] Updated to Llama 3.3
                $reply = $this->call_openai_compatible( $test_message, $api_key, 'https://api.groq.com/openai/v1/chat/completions', 'llama-3.3-70b-versatile', 'Groq' );
                break;
            case 'openai':
            default:
                $reply = $this->call_openai_compatible( $test_message, $api_key, 'https://api.openai.com/v1/chat/completions', 'gpt-3.5-turbo', 'OpenAI' );
                break;
        }

        if ( is_wp_error( $reply ) ) wp_send_json_error( $reply->get_error_message() );
        wp_send_json_success( 'é€£ç·šæˆåŠŸ' );
    }

    // =========================================================================
    // 4. API Wrappers
    // =========================================================================

    private function call_openai_compatible( $message, $api_key, $endpoint, $model, $provider_label = 'API' ) {
        if ( empty( $api_key ) ) return new WP_Error( 'missing_key', 'æœªè¨­å®š ' . $provider_label . ' API Key' );

        $body = [
            'model' => $model,
            'messages' => [
                ['role' => 'system', 'content' => 'You are a helpful WordPress expert assistant. Please answer in Traditional Chinese (Taiwan).'],
                ['role' => 'user', 'content' => $message]
            ],
            'max_tokens' => 1000 
        ];

        if ( strpos( $message, 'Ping Test' ) !== false ) {
            $body['max_tokens'] = 10;
        }

        $args = [
            'body'        => wp_json_encode( $body ),
            'headers'     => [
                'Content-Type'  => 'application/json',
                'Authorization' => 'Bearer ' . $api_key,
            ],
            'timeout'     => 30,
            'sslverify'   => true,
        ];

        $response = wp_remote_post( $endpoint, $args );

        if ( is_wp_error( $response ) ) return $response;
        
        $code = wp_remote_retrieve_response_code( $response );
        if ( $code !== 200 ) {
            $err_msg = $provider_label . ' API éŒ¯èª¤ (' . $code . ')';
            $body_res = json_decode( wp_remote_retrieve_body( $response ), true );
            if(isset($body_res['error']['message'])) $err_msg .= ': ' . $body_res['error']['message'];
            return new WP_Error( 'api_error', $err_msg );
        }

        $body = json_decode( wp_remote_retrieve_body( $response ), true );
        return $body['choices'][0]['message']['content'] ?? 'API å›å‚³æ ¼å¼ç„¡æ³•è§£æ';
    }

    private function call_gemini( $message, $api_key, $enable_search = false ) {
        if ( empty( $api_key ) ) return new WP_Error( 'missing_key', 'æœªè¨­å®š Google Gemini API Key' );

        $models_to_try = ['gemini-1.5-flash'];
        if ( ! $enable_search ) {
            $models_to_try[] = 'gemini-pro';
        }

        $last_error = null;

        foreach ( $models_to_try as $model ) {
            $url = 'https://generativelanguage.googleapis.com/v1beta/models/' . $model . ':generateContent?key=' . $api_key;
            
            $body = [
                'contents' => [
                    [ 'parts' => [ ['text' => "è«‹ç”¨ç¹é«”ä¸­æ–‡(å°ç£)å›ç­”ï¼Œä½ æ˜¯ WordPress å°ˆå®¶ï¼š\n" . $message] ] ]
                ]
            ];

            if ( $enable_search && $model === 'gemini-1.5-flash' ) {
                $body['tools'] = [ ['googleSearch' => new stdClass()] ];
            }

            $args = [
                'body'    => wp_json_encode( $body ),
                'headers' => [ 'Content-Type' => 'application/json' ],
                'timeout' => 45,
                'sslverify' => true,
            ];

            $response = wp_remote_post( $url, $args );

            if ( is_wp_error( $response ) ) {
                $last_error = $response;
                continue;
            }

            $code = wp_remote_retrieve_response_code( $response );

            if ( $code === 200 ) {
                $data = json_decode( wp_remote_retrieve_body( $response ), true );
                return $data['candidates'][0]['content']['parts'][0]['text'] ?? 'API å›å‚³æ ¼å¼ç„¡æ³•è§£æ';
            }

            if ( $code === 404 ) {
                $last_error = new WP_Error( 'api_error', "Gemini æ¨¡å‹ ($model) æœªå•Ÿç”¨æˆ–ä¸æ”¯æ´ (404)" );
                continue;
            }

            $err_body = json_decode( wp_remote_retrieve_body( $response ), true );
            $msg = $err_body['error']['message'] ?? "API éŒ¯èª¤ $code";
            return new WP_Error( 'api_error', "Gemini éŒ¯èª¤: " . $msg );
        }

        return $last_error ?: new WP_Error( 'api_error', 'æ‰€æœ‰ Gemini æ¨¡å‹çš†é€£ç·šå¤±æ•—ï¼Œè«‹æª¢æŸ¥ API æ¬Šé™ã€‚' );
    }
}

new My_Tiny_Admin_AI_Companion();
